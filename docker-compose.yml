# Single stack: start/stop everything with: docker compose up -d | docker compose down
# Project name "olo" isolates this stack from others (containers, network, volumes).
name: olo

services:
  olo-postgres:
    image: postgres:15
    container_name: olo-postgres
    environment:
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: pgpass
      POSTGRES_DB: temporal
    ports:
      - "5432:5432"
    networks:
      - olo-net
    restart: unless-stopped
      
  elasticsearch:
    container_name: olo-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTICSEARCH_VERSION:-7.17.23}
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - cluster.routing.allocation.disk.threshold_enabled=true
      - cluster.routing.allocation.disk.watermark.low=512mb
      - cluster.routing.allocation.disk.watermark.high=256mb
      - cluster.routing.allocation.disk.watermark.flood_stage=128mb
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ports:
      - "9200:9200"
    volumes:
      - olo-elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - olo-net
    restart: unless-stopped

  kibana:
    container_name: olo-kibana
    image: docker.elastic.co/kibana/kibana:${ELASTICSEARCH_VERSION:-7.17.23}
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_NAME=kibana
      - SERVER_PUBLICBASEURL=http://localhost:5601
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - olo-net
    restart: unless-stopped
  temporal:
    container_name: olo-temporal
    image: temporalio/auto-setup:${TEMPORAL_VERSION:-1.22.4}
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=pgpass
      - POSTGRES_SEEDS=olo-postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - ENABLE_ES=true
      - ES_SEEDS=elasticsearch
      - ES_VERSION=v7
      - PROMETHEUS_ENDPOINT=0.0.0.0:8000
    ports:
      - "7233:7233"
      - "8000:8000"
    volumes:
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig
    networks:
      - olo-net
    restart: unless-stopped

  temporal-admin-tools:
    container_name: olo-temporal-admin-tools
    image: temporalio/admin-tools:${TEMPORAL_ADMINTOOLS_VERSION:-1.22.4}
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    stdin_open: true
    tty: true
    networks:
      - olo-net
    restart: unless-stopped

  temporal-ui:
    container_name: olo-temporal-ui
    image: temporalio/ui:${TEMPORAL_UI_VERSION:-2.22.2}
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    ports:
      - "8080:8080"
    networks:
      - olo-net
    restart: unless-stopped

  # ----------------------------
  # Vector DB (Qdrant)
  # ----------------------------
  qdrant:
    container_name: olo-qdrant
    image: qdrant/qdrant:${QDRANT_VERSION:-v1.12.0}
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - olo-qdrant_data:/qdrant/storage
    networks:
      - olo-net
    restart: unless-stopped

  # ----------------------------
  # OSS models (Ollama)
  # ----------------------------
  ollama:
    container_name: olo-ollama
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - olo-ollama_data:/root/.ollama
    networks:
      - olo-net
    restart: unless-stopped

  # ----------------------------
  # OpenAI OSS (LiteLLM proxy â€“ OpenAI-compatible API over Ollama)
  # ----------------------------
  openai-oss:
    container_name: olo-openai-oss
    image: docker.litellm.ai/berriai/litellm:main-latest
    ports:
      - "4000:4000"
    volumes:
      - ./litellm/config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml"]
    depends_on:
      - ollama
    networks:
      - olo-net
    restart: unless-stopped

  # ----------------------------
  # Redis + Redis Insight
  # ----------------------------
  redis:
    container_name: olo-redis
    image: redis:${REDIS_VERSION:-7-alpine}
    ports:
      - "6379:6379"
    volumes:
      - olo-redis_data:/data
    networks:
      - olo-net
    restart: unless-stopped
    command: redis-server --appendonly yes

  redis-insight:
    container_name: olo-redis-insight
    image: redis/redisinsight:${REDIS_INSIGHT_VERSION:-latest}
    ports:
      - "5540:5540"
    volumes:
      - olo-redis-insight_data:/data
    depends_on:
      - redis
    networks:
      - olo-net
    restart: unless-stopped

  # ----------------------------
  # Control Plane (Spring Boot)
  # ----------------------------
#  control-plane:
#    build:
      #context: ./control-plane
     # dockerfile: Dockerfile
    #container_name: olo-control
   # environment:
  #    - TEMPORAL_ADDRESS=temporal:7233
 #     - QDRANT_URL=http://qdrant:6333
#      - OLLAMA_URL=http://ollama:11434
    #ports:
    #  - "8080:8080"
   # depends_on:
  #    - temporal
 #     - qdrant
    #  - ollama
   # networks:
  #    - olo-net

  # ----------------------------
  # React UI
  # ----------------------------
  #ui:
  #  image: ghcr.io/your-org/open-llm-orchestrator-ui:latest
  #  container_name: olo-ui
  #  environment:
  #    - VITE_API_BASE_URL=http://control-plane:8080
  #  ports:
  #    - "3000:3000"
  #  depends_on:
  #    - control-plane
  #  networks:
  #    - olo-net

# ----------------------------
# Network
# ----------------------------
networks:
  olo-net:
    driver: bridge

# ----------------------------
# Volumes
# ----------------------------
volumes:
  olo-ollama_data:
  olo-elasticsearch-data:
  olo-qdrant_data:
  olo-redis_data:
  olo-redis-insight_data: